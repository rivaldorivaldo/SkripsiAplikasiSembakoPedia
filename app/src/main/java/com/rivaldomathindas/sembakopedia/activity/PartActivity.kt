package com.rivaldomathindas.sembakopedia.activityimport android.content.Intentimport android.content.SharedPreferencesimport android.os.Bundleimport android.text.TextUtilsimport android.view.MenuItemimport android.view.Viewimport android.widget.EditTextimport android.widget.ImageViewimport androidx.appcompat.app.AlertDialogimport com.mikepenz.fontawesome_typeface_library.FontAwesomeimport com.mikepenz.ionicons_typeface_library.Ioniconsimport com.synnapps.carouselview.ImageListenerimport kotlinx.android.synthetic.main.activity_product.*import com.rivaldomathindas.sembakopedia.utils.PreferenceHelper.getimport com.google.gson.Gsonimport com.google.gson.JsonObjectimport com.rivaldomathindas.sembakopedia.Rimport com.rivaldomathindas.sembakopedia.model.Productimport com.rivaldomathindas.sembakopedia.base.BaseActivityimport com.rivaldomathindas.sembakopedia.utils.*import com.squareup.okhttp.*import org.jetbrains.anko.alertimport org.jetbrains.anko.toastimport java.io.IOExceptionclass PartActivity : BaseActivity(), ImageListener, View.OnClickListener {    private lateinit var product: Product    private lateinit var prefs: SharedPreferences    override fun onCreate(savedInstanceState: Bundle?) {        super.onCreate(savedInstanceState)        setContentView(R.layout.activity_product)        prefs = PreferenceHelper.defaultPrefs(this)        product = intent.getSerializableExtra(K.product) as Product        initViews()        loadProduct()    }    private fun initViews() {        setSupportActionBar(toolbar4)        supportActionBar?.setDisplayHomeAsUpEnabled(true)        supportActionBar?.setDisplayShowHomeEnabled(true)        supportActionBar?.title = product.name        if (product.sellerId == getUid()) isMine() else notMine()        carousel.pageCount = product.images.size        carousel.setImageListener(this)        seller_icon.setImageDrawable(AppUtils.setDrawable(this, FontAwesome.Icon.faw_user2, R.color.secondaryText, 15))        location_icon.setImageDrawable(AppUtils.setDrawable(this, Ionicons.Icon.ion_location, R.color.secondaryText, 15))        desc_icon.setImageDrawable(AppUtils.setDrawable(this, FontAwesome.Icon.faw_list, R.color.secondaryText, 15))        contactSeller.setOnClickListener(this)        order.setOnClickListener(this)        delete.setOnClickListener(this)    }    override fun setImageForPosition(position: Int, imageView: ImageView?) {        val keys = product.images.keys.toList()        imageView!!.scaleType =ImageView.ScaleType.CENTER_CROP        imageView.loadUrl(product.images[keys[position]]!!)    }    private fun loadProduct() {        seller.text = product.sellerName        location.text = product.location        category.text = product.type        qty.text = product.quantity.toString()        desc.text = product.description        unit.text = "${product.price}"    }    private fun isMine() {        order.hideView()        contactSeller.hideView()        delete.showView()    }    private fun notMine() {        delete.hideView()        contactSeller.showView()        order.showView()    }    override fun onClick(v: View?) {        when(v?.id) {            contactSeller.id -> {                val i = Intent(this, ChatActivity::class.java)                i.putExtra(K.MY_ID, getUid())                i.putExtra(K.OTHER_ID, product.sellerId)                i.putExtra(K.CHAT_NAME, product.sellerName)                startActivity(i)                AppUtils.animateFadein(this)            }            order.id -> {                val view = layoutInflater.inflate(R.layout.make_order,null,false)                val quantity = view.findViewById<EditText>(R.id.orderQuantity)                val location = view.findViewById<EditText>(R.id.orderLocation)                AlertDialog.Builder(this).setTitle(getString(R.string.make_order)).setView(view).setPositiveButton("ORDER") { x, y->                    if (!AppUtils.validated(quantity,location)){                        //return@setPositiveButton                    }                    makeOrder(quantity.text.toString(),location.text.toString())                }.setNegativeButton(getString(R.string.cancel),null).create().show()            }            delete.id -> {                alert(getString(R.string.delete) + " " + product.name) {                    positiveButton(getString(R.string.delete)) {                        getFirestore().collection(K.PRODUCTS).document(product.id!!).delete()                                .addOnSuccessListener {                                    toast(product.name + " " + getString(R.string.deleted))                                    finish()                                    AppUtils.animateEnterLeft(this@PartActivity)                                }                    }                    negativeButton(R.string.cancel) {}                }.show()            }        }    }    private fun makeOrder(quantity: String, location: String) {        if (TextUtils.isEmpty(quantity) || TextUtils.isEmpty(location)) {            toast(getString(R.string.please_fill_all_fields))            return        }        showLoading(getString(R.string.making_order))        val client = OkHttpClient()        val urlBuilder = HttpUrl.parse(K.MAKE_ORDER_URL)?.newBuilder()        urlBuilder?.addQueryParameter("product_id", product.id)        urlBuilder?.addQueryParameter("product_name", product.name)        urlBuilder?.addQueryParameter("buyer_id", getUid())        urlBuilder?.addQueryParameter("buyer_name", prefs[K.NAME])        urlBuilder?.addQueryParameter("seller_id", product.sellerId)        urlBuilder?.addQueryParameter("seller_name", product.sellerName)        urlBuilder?.addQueryParameter("location", location)        urlBuilder?.addQueryParameter("quantity", quantity)        urlBuilder?.addQueryParameter("image_url", product.image)        urlBuilder?.addQueryParameter("time", System.currentTimeMillis().toString())        val url = urlBuilder?.build().toString()        val request = Request.Builder().url(url).build()        client.newCall(request).enqueue(object: Callback {            override fun onFailure(request: Request?, e: IOException?) {                e?.printStackTrace()                runOnUiThread {                    hideLoading()                    toast(getString(R.string.error_making_order))                }            }            override fun onResponse(response: Response?) {                runOnUiThread {                    hideLoading()                }                val res = response?.body()?.string()                if (response!!.isSuccessful) {                    try {                        val gson = Gson()                        val json = gson.fromJson(res, JsonObject::class.java)                        val resultCode = json["resultCode"].asInt                        runOnUiThread {                            when(resultCode){                                -1 -> {                                    alert(json["description"].asString, "Failed").show()                                }                                0 -> {                                    alert(json["description"].asString, "Success").show()                                    qty.text = json["available"].asString                                }                            }                        }                    }catch (e:Exception){}                }            }        })    }    override fun onOptionsItemSelected(item: MenuItem?): Boolean {        when(item?.itemId) {            android.R.id.home -> onBackPressed()        }        return true    }    override fun onBackPressed() {        super.onBackPressed()        AppUtils.animateEnterLeft(this)    }}